<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Stock Predictor 종목 상세 페이지" />
    <meta name="keywords" content="주식, 투자, Stock Predictor" />
    <meta name="author" content="Jo YoungRan" />
    <title>종목 상세 - Stock Predictor</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/common.css" />
    <link rel="stylesheet" href="/css/stock-detail.css">
    <link rel="stylesheet" href="/css/memo-modal.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>

    <script src="/js/stock-detail.js"></script>
    <script src="/js/nav.js"></script>
    <script src="/js/memo-modal.js"></script>

    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
</head>
<body>
<header>
    <div th:replace="~{fragments/nav :: nav}"></div>
</header>

<main class="container py-4">

    <!-- 상단 종목 정보 -->
    <section class="mb-4 d-flex justify-content-between align-items-center flex-wrap">
        <div>
            <h2 class="mb-1" th:text="${stock.name} + ' (' + ${stock.ticker} + ')'"></h2>
        </div>
        <button
            class="btn btn-outline-warning favorite-btn"
            th:classappend="${isFavorite} ? ' active' : ''"
            th:data-ticker="${stock.ticker}">
            ⭐ 즐겨찾기
        </button>
    </section>

    <!-- 가격 차트 -->
    <section class="mb-4" id="chartSection" th:data-ticker="${stock.ticker}">
        <h4 class="mb-3">📈 가격 차트</h4>
        <ul class="nav nav-tabs mb-2" id="chartTab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="week-tab" data-period="week" data-bs-toggle="tab">1주</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="month-tab" data-period="month" data-bs-toggle="tab">1개월</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="year-tab" data-period="year" data-bs-toggle="tab">1년</button>
            </li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane fade show active chart-area" id="chart">
                <canvas id="candleChart"></canvas>
            </div>
        </div>
        <div id="detailPanel" style="margin-top:10px;"></div>
        <button id="helpBtn" class="btn btn-outline-info btn-sm mt-2">📘 캔들 보는 법</button>
        <button id="resetZoomBtn" class="btn btn-outline-info btn-sm mt-2">🔄 줌 초기화</button>

        <div id="helpCard" class="card shadow-sm mt-2" style="display:none;">
            <div class="card-body small">
                <strong>캔들 해석 가이드</strong>
                <ul class="mb-0">
                    <li>본체(직사각형): 시가~종가</li>
                    <li>윗꼬리/아랫꼬리: 고가/저가</li>
                    <li>색상: 상승(초록) / 하락(빨강)</li>
                    <li>거래량: 가격 움직임의 신뢰도</li>
                </ul>
            </div>
        </div>
    </section>

    <!-- 가치평가 지표 -->
    <section class="mb-4">
        <h4 class="mb-3">💹 가치평가 지표</h4>
        <div class="indicator-card d-flex flex-wrap gap-3">
            <span>PER: <span th:text="${valuationMetric.per}">12.3</span></span>
            <span>PBR: <span th:text="${valuationMetric.pbr}">1.1</span></span>
            <span>ROE: <span th:text="${valuationMetric.roe}">15%</span></span>
            <span>EPS: <span th:text="${valuationMetric.eps}">3,500</span></span>
            <span>BPS: <span th:text="${valuationMetric.bps}">25,000</span></span>
            <span>DPS: <span th:text="${valuationMetric.dps}">500</span></span>
            <span>Dividend Yield: <span th:text="${valuationMetric.dividendYield}">2%</span></span>
        </div>
    </section>

    <!-- 예상 주가 (확률 기반) -->
    <section class="mb-4">
        <h4 class="mb-3">🔮 예상 주가 (확률 기반)</h4>
        <div class="row g-3">

            <!-- 내일 예측 -->
            <div class="col-md-6 col-lg-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h6 class="card-title">2025-08-20 예측</h6>
                        <p class="mb-2 small text-muted">모델: LSTM</p>

                        <label class="fw-bold">상승 확률</label>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-success" role="progressbar"
                                 style="width: 65%;">65%</div>
                        </div>

                        <label class="fw-bold">하락 확률</label>
                        <div class="progress">
                            <div class="progress-bar bg-danger" role="progressbar"
                                 style="width: 35%;">35%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 1주 후 예측 -->
            <div class="col-md-6 col-lg-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h6 class="card-title">2025-08-27 예측</h6>
                        <p class="mb-2 small text-muted">모델: Prophet</p>

                        <label class="fw-bold">상승 확률</label>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-success" role="progressbar"
                                 style="width: 55%;">55%</div>
                        </div>

                        <label class="fw-bold">하락 확률</label>
                        <div class="progress">
                            <div class="progress-bar bg-danger" role="progressbar"
                                 style="width: 45%;">45%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 1개월 후 예측 -->
            <div class="col-md-6 col-lg-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h6 class="card-title">2025-09-19 예측</h6>
                        <p class="mb-2 small text-muted">모델: XGBoost</p>

                        <label class="fw-bold">상승 확률</label>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-success" role="progressbar"
                                 style="width: 40%;">40%</div>
                        </div>

                        <label class="fw-bold">하락 확률</label>
                        <div class="progress">
                            <div class="progress-bar bg-danger" role="progressbar"
                                 style="width: 60%;">60%</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </section>

    <!-- 나의 메모 -->
    <section class="mb-4">
        <h4 class="mb-3">📝 나의 메모</h4>

        <!-- 새 메모 작성 박스 -->
        <form th:action="@{/memo}" method="post" class="memo-box mb-3">
            <!-- 종목 티커 hidden -->
            <input type="hidden" name="stockId" th:value="${stock.id}">

            <!-- 메모 제목 (선택 입력) -->
            <input type="text" class="form-control mb-2" placeholder="메모 제목 (선택)" name="title">

            <!-- 메모 내용 -->
            <textarea class="form-control" placeholder="새 메모를 작성하세요..." name="content" required></textarea>

            <div class="text-end mt-2">
                <button type="submit" class="btn btn-primary btn-sm">저장</button>
            </div>
        </form>

        <!-- 기존 메모 카드 목록 -->
        <div class="row g-3">
            <div class="col-md-6 col-lg-4" th:each="memo : ${memoPage.content}">
                <div class="card shadow-sm h-100 bg-dark text-white border-light memo-card">
                    <div class="card-body d-flex flex-column">

                        <!-- 메모 제목 또는 생성일 -->
                        <h5 class="card-title" th:text="${memo.title != null} ? ${memo.title} : ${#temporals.format(memo.createdAt, 'yyyy-MM-dd HH:mm')}">
                            메모 제목/날짜
                        </h5>

                        <!-- 메모 내용 (간략 표시, 길면 ... 처리) -->
                        <p class="card-text text-truncate" th:text="${memo.content}" style="max-height: 4.5rem; overflow: hidden;">
                            메모 내용
                        </p>

                        <!-- 버튼 영역 -->
                        <div class="mt-auto text-end">
                            <button class="btn btn-sm btn-outline-primary" type="button"
                                    th:attr="data-memo-id=${memo.id}">
                                자세히 보기
                            </button>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- 페이지네이션 -->
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center mt-3">
                <li class="page-item" th:classappend="${memoPage.first} ? 'disabled'">
                    <a class="page-link" th:href="@{/stock-detail(ticker=${stock.ticker}, page=${memoPage.number - 1})}">Previous</a>
                </li>
                <li class="page-item" th:each="i : ${#numbers.sequence(0, memoPage.totalPages - 1)}"
                    th:classappend="${i == memoPage.number} ? 'active'">
                    <a class="page-link" th:href="@{/stock-detail(ticker=${stock.ticker}, page=${i})}" th:text="${i + 1}">1</a>
                </li>
                <li class="page-item" th:classappend="${memoPage.last} ? 'disabled'">
                    <a class="page-link" th:href="@{/stock-detail(ticker=${stock.ticker}, page=${memoPage.number + 1})}">Next</a>
                </li>
            </ul>
        </nav>

    </section>

</main>

<!-- memo 모달-->
<div th:replace="~{fragments/memo-modal :: memoModal}"></div>

<div th:replace="~{fragments/footer :: footer}"></div>

<!-- 로그아웃 확인 모달 -->
<div th:replace="~{fragments/logout-modal :: logoutModal}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
